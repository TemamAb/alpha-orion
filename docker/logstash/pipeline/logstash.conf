input {
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed_json"
    }
  }

  # Extract common fields
  if [parsed_json][timestamp] {
    date {
      match => ["parsed_json[timestamp]", "ISO8601", "yyyy-MM-dd HH:mm:ss,SSS", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"]
      target => "@timestamp"
    }
  }

  # Add service name from container name
  if [docker][container][name] {
    mutate {
      add_field => {
        "service" => "%{[docker][container][name]}"
      }
    }
  }

  # Parse log levels
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:log_timestamp} - %{LOGLEVEL:log_level} - %{GREEDYDATA:log_message}" }
    overwrite => ["message"]
  }

  # Extract trading-specific information
  if [log_message] =~ /profit|trade|arbitrage/i {
    grok {
      match => { "log_message" => ".*profit[:\s]+%{NUMBER:profit_amount}.*" }
    }
    grok {
      match => { "log_message" => ".*gas[:\s]+%{NUMBER:gas_used}.*" }
    }
    grok {
      match => { "log_message" => ".*latency[:\s]+%{NUMBER:latency_ms}.*" }
    }
  }

  # Clean up fields
  mutate {
    remove_field => ["parsed_json", "beat", "host", "@version"]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "alpha-orion-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Also send to stdout for debugging
  stdout {
    codec => rubydebug
  }
}
