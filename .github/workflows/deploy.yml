name: Deploy to GCP
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GCP_PROJECT: alpha-orion
  GAR_LOCATION: us-central1

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python dependencies
      run: |
        pip install -r backend-services/requirements.txt
        for service in backend-services/services/*/; do
          if [ -f "${service}requirements.txt" ]; then
            pip install -r "${service}requirements.txt"
          fi
        done

    - name: Run Python linting
      run: |
        for service in backend-services/services/*/; do
          if [ -d "${service}src" ]; then
            flake8 "${service}src" --max-line-length=88 --extend-ignore=E203,W503
            black --check "${service}src"
          fi
        done

    - name: Run Python tests
      run: |
        for service in backend-services/services/*/; do
          if [ -d "${service}tests" ]; then
            pytest "${service}tests" --cov="${service}src" --cov-report=xml
          fi
        done

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Node.js dependencies and run tests
      run: |
        for service in backend-services/services/user-api-service backend-services/services/withdrawal-service frontend; do
          if [ -f "${service}/package.json" ]; then
            cd "${service}"
            npm install
            npm run lint || true  # ESLint
            npm run format:check || true  # Prettier check
            npm test -- --coverage --passWithNoTests
            cd -
          fi
        done

    - name: Run E2E tests
      run: |
        cd frontend
        npm run cypress:run
        cd -

    - name: Security scan
      uses: github/super-linter/slim@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Build and Push Docker Images
      run: |
        # Build and push all services
        for service in scanner orchestrator executor backend frontend frontend-dashboard; do
          if [ -d "./${service}" ]; then
            docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/${service}:${{ github.sha }} ./${service}/
            docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/${service}:${{ github.sha }}
          fi
        done

    - name: Update Terraform Image References
      run: |
        # Update main.tf with new image tags
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/scanner-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/orchestrator-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/executor-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/backend-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/frontend-service:${{ github.sha }}|g" terraform/main.tf

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0

    - name: Terraform Init
      working-directory: terraform/
      run: terraform init

    - name: Terraform Plan
      working-directory: terraform/
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main'
      working-directory: terraform/
      run: terraform apply -auto-approve tfplan
