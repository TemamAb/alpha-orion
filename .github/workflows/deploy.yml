name: Deploy to GCP
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GCP_PROJECT: alpha-orion
  GAR_LOCATION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Build and Push Docker Images
      run: |
        # Build and push all services
        for service in scanner orchestrator executor backend frontend; do
          if [ -d "./${service}" ]; then
            docker build -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/${service}:${{ github.sha }} ./${service}/
            docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/${service}:${{ github.sha }}
          fi
        done

    - name: Update Terraform Image References
      run: |
        # Update main.tf with new image tags
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/scanner-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/orchestrator-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/executor-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/backend-service:${{ github.sha }}|g" terraform/main.tf
        sed -i "s|us-docker.pkg.dev/cloudrun/container/hello|${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT }}/alpha-orion-repo/frontend-service:${{ github.sha }}|g" terraform/main.tf

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0

    - name: Terraform Init
      working-directory: terraform/
      run: terraform init

    - name: Terraform Plan
      working-directory: terraform/
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main'
      working-directory: terraform/
      run: terraform apply -auto-approve tfplan
