options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: 'us-central1'

steps:
  # USER API SERVICE
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-user-api'
    dir: 'backend-services/services/user-api-service/src'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/user-api-service:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/user-api-service:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-user-api'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'user-api-service'
      - '--image'
      - 'gcr.io/$PROJECT_ID/user-api-service:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--memory=2Gi'
      - '--cpu=2'
      - '--min-instances=1'
      - '--max-instances=10'
      - '--timeout=3600s'
      - '--set-env-vars=PORT=8080,NODE_ENV=production,GCP_PROJECT_ID=$PROJECT_ID'
      - >-
        --set-secrets=DATABASE_URL=DATABASE_URL:latest,REDIS_URL=REDIS_URL:latest,JWT_SECRET_KEY=JWT_SECRET_KEY:latest,PIMLICO_API_KEY=PIMLICO_API_KEY:latest,ONE_INCH_API_KEY=ONE_INCH_API_KEY:latest,GEMINI_API_KEY=GEMINI_API_KEY:latest,ETHEREUM_RPC_URL=ETHEREUM_RPC_URL:latest,PROFIT_WALLET_ADDRESS=PROFIT_WALLET_ADDRESS:latest

  # BRAIN ORCHESTRATOR
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-brain-orchestrator'
    dir: 'backend-services/services/brain-orchestrator'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/brain-orchestrator:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/brain-orchestrator:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-brain-orchestrator'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'brain-orchestrator'
      - '--image'
      - 'gcr.io/$PROJECT_ID/brain-orchestrator:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--no-allow-unauthenticated'
      - '--memory=1Gi'
      - '--cpu=2'
      - '--set-env-vars=PYTHONUNBUFFERED=1,GCP_PROJECT_ID=$PROJECT_ID'

  # BRAIN AI OPTIMIZER
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-brain-ai-optimizer'
    dir: 'backend-services/services/brain-ai-optimization-orchestrator'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/brain-ai-optimizer:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/brain-ai-optimizer:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-brain-ai-optimizer'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'brain-ai-optimizer'
      - '--image'
      - 'gcr.io/$PROJECT_ID/brain-ai-optimizer:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--no-allow-unauthenticated'
      - '--memory=2Gi'
      - '--cpu=2'
      - '--set-env-vars=PYTHONUNBUFFERED=1,GCP_PROJECT_ID=$PROJECT_ID'

  # BLOCKCHAIN MONITOR
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-blockchain-monitor'
    dir: 'backend-services/services/blockchain-monitor'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/blockchain-monitor:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/blockchain-monitor:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-blockchain-monitor'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'blockchain-monitor'
      - '--image'
      - 'gcr.io/$PROJECT_ID/blockchain-monitor:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--no-allow-unauthenticated'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--set-env-vars=PYTHONUNBUFFERED=1,GCP_PROJECT_ID=$PROJECT_ID'

  # COMPLIANCE SERVICE
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-compliance-service'
    dir: 'backend-services/services/compliance-service'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/compliance-service:$COMMIT_SHA', '.']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/compliance-service:$COMMIT_SHA']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-compliance-service'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'compliance-service'
      - '--image'
      - 'gcr.io/$PROJECT_ID/compliance-service:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--no-allow-unauthenticated'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--set-env-vars=PYTHONUNBUFFERED=1,GCP_PROJECT_ID=$PROJECT_ID'

images:
  - 'gcr.io/$PROJECT_ID/user-api-service:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/brain-orchestrator:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/brain-ai-optimizer:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/blockchain-monitor:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/compliance-service:$COMMIT_SHA'
