
import React, { useState, useCallback } from 'react';
import { Terminal, AlertTriangle, CheckCircle, Code, Shield, Send, Cpu } from 'lucide-react';
import { GoogleGenAI } from "@google/genai";

// --- Components ---

const Header = () => (
  <header className="border-b border-gray-800 p-6 flex justify-between items-center sticky top-0 bg-gray-900/80 backdrop-blur-md z-50">
    <div className="flex items-center gap-3">
      <div className="p-2 bg-blue-600 rounded-lg">
        <Cpu className="w-6 h-6 text-white" />
      </div>
      <h1 className="text-xl font-bold tracking-tight">Alpha-Orion Deployer</h1>
    </div>
    <nav className="hidden md:flex gap-6 text-sm font-medium text-gray-400">
      <a href="#logs" className="hover:text-white transition-colors">Logs</a>
      <a href="#fix" className="hover:text-white transition-colors">Fixed Code</a>
      <a href="#steps" className="hover:text-white transition-colors">Step-by-Step</a>
    </nav>
  </header>
);

const ErrorDisplay = ({ error }: { error: string }) => (
  <div className="bg-red-900/20 border border-red-500/50 p-4 rounded-xl mb-6 flex gap-3">
    <AlertTriangle className="w-5 h-5 text-red-500 shrink-0" />
    <div>
      <h3 className="font-bold text-red-500">Critical Syntax Error Detected</h3>
      <p className="text-sm text-red-200 mt-1">{error}</p>
    </div>
  </div>
);

const InstructionCard = ({ title, steps, icon: Icon }: { title: string, steps: string[], icon: any }) => (
  <div className="bg-gray-800/50 border border-gray-700 p-6 rounded-2xl">
    <div className="flex items-center gap-3 mb-4">
      <Icon className="w-5 h-5 text-blue-400" />
      <h2 className="text-lg font-semibold">{title}</h2>
    </div>
    <ul className="space-y-3">
      {steps.map((step, idx) => (
        <li key={idx} className="flex gap-3 text-sm text-gray-400 leading-relaxed">
          <span className="font-mono text-blue-500 font-bold">{idx + 1}.</span>
          {step}
        </li>
      ))}
    </ul>
  </div>
);

// --- Main App ---

export default function App() {
  const [logInput, setLogInput] = useState("");
  const [analysis, setAnalysis] = useState<string | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  const analyzeWithAI = useCallback(async () => {
    if (!logInput.trim()) return;
    setIsAnalyzing(true);
    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: `Analyze this Render build log and provide a concise 3-step fix instruction for a Node.js React developer. Focus on the JSX tags error in Dashboard.tsx.
        Log: ${logInput}`,
        config: {
          systemInstruction: "You are a world-class DevOps engineer specializing in React build failures. Be extremely precise about line numbers and syntax.",
        }
      });
      setAnalysis(response.text || "Could not analyze the log. Check console for details.");
    } catch (err) {
      setAnalysis("Error communicating with AI analysis engine. Ensure your connection is stable.");
    } finally {
      setIsAnalyzing(false);
    }
  }, [logInput]);

  return (
    <div className="max-w-6xl mx-auto pb-20">
      <Header />

      <main className="p-6">
        {/* Urgent Alert */}
        <div className="mb-10">
          <ErrorDisplay 
            error="Unexpected closing 'div' tag does not match opening 'code' tag in Dashboard.tsx around line 17. The parser thinks you are closing a UI element instead of writing text."
          />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* Instructions Section */}
          <div className="lg:col-span-2 space-y-8">
            <section id="steps">
              <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                <CheckCircle className="text-green-500" />
                Deployment Instructions for Agent
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <InstructionCard 
                  title="Environment Config"
                  icon={Shield}
                  steps={[
                    "Ensure Node.js version is set to 20.x in Render environment settings.",
                    "Set 'Build Command' to 'npm install && npm run build'.",
                    "Set 'Publish Directory' to 'dist' (standard for Vite).",
                    "Add API_KEY to environment variables."
                  ]}
                />
                <InstructionCard 
                  title="Build Fixes"
                  icon={Code}
                  steps={[
                    "Escape literal tags: Replace '<code></div></code>' with '<code>&lt;/div&gt;</code>'.",
                    "Balance the Dashboard.tsx line 1056. Remove extra closing '</div>' tags.",
                    "Verify matching parentheses for ternary operators at lines 1054-1057.",
                    "Run 'npm run build' locally to confirm zero syntax errors before pushing."
                  ]}
                />
              </div>
            </section>

            <section id="fix" className="mt-10">
              <h3 className="text-lg font-semibold mb-4 text-gray-300">Target Correction for Dashboard.tsx</h3>
              <div className="bg-black rounded-xl p-5 font-mono text-sm border border-gray-800 overflow-x-auto">
                <p className="text-gray-500 mb-2">// Line 17 fix</p>
                <code className="text-blue-300">
                  This often happens when there's an extra closing &lt;code&gt;&amp;lt;/div&amp;gt;&lt;/code&gt; tag,
                </code>
                <div className="mt-4 border-t border-gray-800 pt-4">
                  <p className="text-gray-500 mb-2">// Lines 1054-1056 resolution</p>
                  <pre className="text-green-400">
{`1053:    </div>
1054:  </div>
1055: )}
1056: // Remove the extra </div> here that was causing the imbalance.`}
                  </pre>
                </div>
              </div>
            </section>
          </div>

          {/* AI Log Analysis Tool */}
          <div className="lg:col-span-1">
            <div className="bg-gray-800 border border-gray-700 rounded-2xl p-6 sticky top-28">
              <div className="flex items-center gap-2 mb-4">
                <Terminal className="text-blue-400" />
                <h3 className="font-bold">Log Analyzer</h3>
              </div>
              <p className="text-xs text-gray-400 mb-4">
                Paste your latest Render build logs here to generate a custom remediation plan.
              </p>
              <textarea 
                className="w-full h-48 bg-gray-900 border border-gray-700 rounded-lg p-3 text-xs font-mono text-gray-300 focus:ring-1 focus:ring-blue-500 focus:outline-none mb-4"
                placeholder="Paste [vite:esbuild] error output here..."
                value={logInput}
                onChange={(e) => setLogInput(e.target.value)}
              />
              <button 
                onClick={analyzeWithAI}
                disabled={isAnalyzing || !logInput}
                className="w-full py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 text-white rounded-xl font-medium transition-all flex items-center justify-center gap-2"
              >
                {isAnalyzing ? (
                  <>
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                    Thinking...
                  </>
                ) : (
                  <>
                    <Send className="w-4 h-4" />
                    Analyze & Solve
                  </>
                )}
              </button>

              {analysis && (
                <div className="mt-6 p-4 bg-gray-900 border border-blue-500/30 rounded-xl text-xs leading-relaxed text-blue-100 whitespace-pre-wrap animate-in fade-in slide-in-from-top-2 duration-300">
                  <div className="flex items-center gap-2 mb-2 text-blue-400 font-bold uppercase tracking-wider text-[10px]">
                    <Shield className="w-3 h-3" />
                    AI Recommendation
                  </div>
                  {analysis}
                </div>
              )}
            </div>
          </div>

        </div>
      </main>

      <footer className="fixed bottom-0 left-0 right-0 p-4 bg-gray-900/90 backdrop-blur-sm border-t border-gray-800 text-center text-xs text-gray-500">
        Internal Tool: Alpha-Orion Deployment Intelligence â€¢ Protocol v3.1
      </footer>
    </div>
  );
}
