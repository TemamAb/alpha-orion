version: '3.8'

services:
  # Test Database
  test-postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=test
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
    ports:
      - "5432:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d test"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Test Redis
  test-redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Brain Orchestrator (Test)
  brain-orchestrator-test:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SERVICE_NAME=brain-orchestrator
      - REDIS_URL=redis://test-redis:6379
      - DATABASE_URL=postgresql://test:test@test-postgres:5432/test
      - COMPLIANCE_SERVICE_URL=http://compliance-service-test:8003
    volumes:
      - ./backend-services/services/brain-orchestrator/src:/app/backend-services/services/brain-orchestrator/src
    depends_on:
      test-redis:
        condition: service_healthy
      test-postgres:
        condition: service_healthy
    command: ["python", "backend-services/services/brain-orchestrator/src/main.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Compliance Service (Test)
  compliance-service-test:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    ports:
      - "8003:8003"
    environment:
      - SERVICE_NAME=compliance-service
      - REDIS_URL=redis://test-redis:6379
    volumes:
      - ./backend-services/services/compliance-service/src:/app/backend-services/services/compliance-service/src
    depends_on:
      test-redis:
        condition: service_healthy
    command: ["python", "backend-services/services/compliance-service/src/main.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # AI Optimizer (Test)
  ai-optimizer-test:
    build:
      context: .
      dockerfile: docker/scanner.Dockerfile
    ports:
      - "8081:8080"
    environment:
      - SERVICE_NAME=brain-ai-optimization-orchestrator
      - REDIS_URL=redis://test-redis:6379
      - DATABASE_URL=postgresql://test:test@test-postgres:5432/test
      - ENABLE_ML_PIPELINE=true
    volumes:
      - ./backend-services/services/brain-ai-optimization-orchestrator/src:/app
    depends_on:
      test-redis:
        condition: service_healthy
      test-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  postgres_test_data:
