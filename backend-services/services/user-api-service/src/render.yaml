# render.yaml
# Blueprint for deploying the Alpha-Orion backend services on Render.

# 1. Define environment variable groups for secrets
# Best practice: Create this group in the Render Dashboard under "Environment".
envVarGroups:
  - name: alpha-orion-secrets
    envVars:
      - key: OPENAI_API_KEY
        sync: false # Paste value in Render dashboard, don't commit to yaml
      - key: PRIVATE_KEY
        sync: false # Paste value in Render dashboard
      - key: INFURA_API_KEY
        sync: false # Paste value in Render dashboard

# 2. Define the services (web apps, background workers, etc.)
services:
  # 2a. The main User API Service (Node.js backend)
  - type: web
    name: user-api-service
    runtime: node
    plan: starter # 'free' plan may sleep, use 'starter' or higher for production
    # Set the root directory to where package.json is located
    rootDir: backend-services/services/user-api-service
    # Build and start commands from package.json
    buildCommand: "npm install && npm run build"
    startCommand: "npm start"
    healthCheckPath: /health
    envVars:
      - fromGroup: alpha-orion-secrets # Reference the secret group
      - key: DATABASE_URL
        fromDatabase:
          name: alpha-orion-db # Must match the database name below
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: alpha-orion-redis # Must match the redis name below
          property: connectionString
      - key: JWT_SECRET
        generateValue: true # Let Render generate a secure, random secret
      - key: NODE_ENV
        value: production
      # The URL for the AI Optimizer service will be automatically injected by Render
      # if you define it as another service in this file.
      - key: AI_OPTIMIZER_URL
        value: http://ai-optimizer-service:8081 # Example, replace with your service name and port

  # 2b. Live Metrics Server
  - type: web
    name: live-metrics-server
    runtime: node
    plan: starter
    rootDir: backend-services/services/live-metrics-server
    buildCommand: "npm install && npm run build"
    startCommand: "npm start"
    envVars:
      - fromGroup: alpha-orion-secrets
      - key: REDIS_URL
        fromService:
          type: redis
          name: alpha-orion-redis
          property: connectionString
      - key: NODE_ENV
        value: production

  # 2c. Blockchain Monitor (Background Worker)
  - type: worker
    name: blockchain-monitor
    runtime: python
    rootDir: backend-services/services/blockchain-monitor
    buildCommand: "pip install -r requirements.txt"
    startCommand: "python src/main.py"
    envVars:
      - fromGroup: alpha-orion-secrets
      - key: REDIS_URL
        fromService:
          type: redis
          name: alpha-orion-redis
          property: connectionString

  # 2d. AI Optimizer (Private Service)
  # Accessible ONLY by other services (like user-api-service) at http://ai-optimizer-service:port
  - type: pserve
    name: ai-optimizer-service
    runtime: python
    rootDir: backend-services/services/brain-orchestrator
    buildCommand: "pip install -r requirements.txt"
    startCommand: "python src/main.py"
    envVars:
      - fromGroup: alpha-orion-secrets
      - key: PORT
        value: "8081" # Matches the port defined in user-api-service env vars

  # 2e. Hourly Cron Job
  - type: cron
    name: hourly-maintenance
    runtime: node
    plan: starter
    rootDir: backend-services/services/user-api-service
    schedule: "0 * * * *" # Runs every hour on the hour
    buildCommand: "npm install"
    startCommand: "node src/scripts/hourly-job.js" # Replace with the path to your script
    envVars:
      - fromGroup: alpha-orion-secrets
      - key: DATABASE_URL
        fromDatabase:
          name: alpha-orion-db
          property: connectionString

# 3. Define the managed databases and caches
databases:
  # 3a. PostgreSQL Database
  - name: alpha-orion-db
    databaseName: alpha_orion_db # The name of the database inside Postgres
    user: alpha_orion_user
    plan: starter # Use a plan that matches your production needs

  # 3b. Redis Cache
  - name: alpha-orion-redis
    plan: starter
    ipAllowList:
      - source: 203.0.113.1/32 # Replace with your actual public IP address
        description: "Local Development Machine"