# Alpha-Orion Unified Render Deployment
# Version: 6.0 - Blueprint with AI Service
# Version: 7.0 - Added Redis with IP Whitelist

services:
  # 1. Unified Frontend + User API Service (Gateway)
  - type: web
    name: alpha-orion-alpha
    env: docker
    plan: starter
    rootDir: .
    envVars:
      - key: NODE_ENV
        value: production
      # Link to the Python AI service. Render handles the URL automatically.
      - key: AI_SERVICE_URL
        fromService:
          type: web
          name: alpha-orion-brain
          property: url
      - key: JWT_SECRET
        generateValue: true
      # Blockchain RPC URLs (Public - No API key needed)
      - key: POLYGON_RPC_URL
        value: https://polygon-rpc.com
      - key: ETHEREUM_RPC_URL
        value: https://eth.llamarpc.com
      - key: ARBITRUM_RPC_URL
        value: https://arb1.arbitrum.io/rpc
      - key: OPTIMISM_RPC_URL
        value: https://mainnet.optimism.io
      - key: BASE_RPC_URL
        value: https://mainnet.base.org
      - key: BSC_RPC_URL
        value: https://bsc-dataseed.binance.org
      - key: WALLET_ADDRESS
        sync: false
      - key: FLASH_LOAN_EXECUTOR_ADDRESS
        sync: false
      - key: PIMLICO_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      # Error Notification Webhooks (Optional)
      # Telegram: Get bot token from @BotFather, chat ID from @userinfobot
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false
      # Discord: Create webhook in Server Settings > Integrations > Webhooks
      - key: DISCORD_WEBHOOK_URL
        sync: false
      # Custom webhook for any HTTP endpoint
      - key: ERROR_WEBHOOK_URL
        sync: false
      # Redis connection - uses internal URL for private networking
      - key: REDIS_URL
        fromService:
          type: redis
          name: alpha-orion-redis
          property: internalUrl
    healthCheckPath: /health

  # 2. Brain AI Optimization Orchestrator (Python)
  - type: web
    name: alpha-orion-brain
    env: python
    plan: starter
    rootDir: backend-services/services/brain-ai-optimization-orchestrator
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn src.app:app
    envVars:
      - key: PYTHON_VERSION
        value: 3.10.0
      - key: OPENAI_API_KEY
        sync: false
      # Error Notification Webhooks (Optional)
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false
      - key: DISCORD_WEBHOOK_URL
        sync: false
      - key: ERROR_WEBHOOK_URL
        sync: false
      # Redis connection - uses internal URL for private networking
      - key: REDIS_URL
        fromService:
          type: redis
          name: alpha-orion-redis
          property: internalUrl
    healthCheckPath: /health

# 3. Redis Service with Private Networking
# Provides caching and DLQ support with IP whitelist for security
redis:
  - name: alpha-orion-redis
    plan: starter
    # IP whitelist for enhanced security - allow internal services
    # Note: Render manages internal networking automatically
    # Additional IP restrictions can be configured via Render dashboard
    ipAllowList: []
    maxmemory: 256mb
    evictionPolicy: allkeys-lru
