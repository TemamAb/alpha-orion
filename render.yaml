# Alpha-Orion: Infrastructure as Code for Render
# This file defines all the services, databases, and environment configurations
# required to run the Alpha-Orion platform on Render.

envVarGroups:
  - name: alpha-orion-secrets
    envVars:
      - key: JWT_SECRET
        generateValue: true # Let Render generate a secure secret
      - key: OPENAI_API_KEY
        sync: false # Manually set in Render dashboard for security
      - key: PIMLICO_API_KEY
        sync: false
      - key: INFURA_API_KEY
        sync: false
      - key: PRIVATE_KEY
        sync: false

databases:
  - name: alpha-orion-db
    databaseName: alpha_orion_db
    plan: free
    ipAllowList: [] # Allows all services in the account to connect

  - name: alpha-orion-redis
    plan: free
    ipAllowList: []

services:
  # ----------------------------------------------------
  #  Backend API: The main public-facing service
  # ----------------------------------------------------
  - type: web
    name: user-api-service
    plan: starter # As mentioned in README
    runtime: docker
    # The Docker build context is the root to copy the shared 'strategies' folder
    dockerContext: .
    dockerfilePath: ./backend-services/services/user-api-service/Dockerfile
    healthCheckPath: /health
    envVars:
      - fromGroup: alpha-orion-secrets
      - key: DATABASE_URL
        fromDatabase:
          name: alpha-orion-db
          property: connectionString
      - key: REDIS_URL
        fromRedis:
          name: alpha-orion-redis
          property: connectionString

  # ----------------------------------------------------
  #  Brain Orchestrator: The core trading logic worker
  # ----------------------------------------------------
  - type: worker
    name: brain-orchestrator
    plan: free
    runtime: python
    rootDir: ./backend-services/services/brain-orchestrator
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn --worker-class gevent --bind 0.0.0.0:8080 main:app
    envVars:
      - fromGroup: alpha-orion-secrets
      - key: DATABASE_URL
        fromDatabase:
          name: alpha-orion-db
          property: connectionString
      - key: REDIS_URL
        fromRedis:
          name: alpha-orion-redis
          property: connectionString
      # For service-to-service communication
      - key: USER_API_URL
        value: "https://user-api-service.onrender.com"

  # ----------------------------------------------------
  #  Frontend Dashboard: The static React application
  # ----------------------------------------------------
  - type: static
    name: dashboard
    plan: free
    rootDir: ./dashboard
    buildCommand: npm install && npm run build
    publishDir: dist # Vite's default build output is 'dist'
    # Add rewrite rules for single-page applications (SPA)
    routes:
      - type: rewrite
        source: /*
        destination: /index.html